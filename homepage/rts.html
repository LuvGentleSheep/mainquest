<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Real Time Subtitle</title>
<style>
:root{--accent:#4f46e5;--bg:#f8fafc;--text:#1e293b;--sidebar:250px}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}
/* é¡¶æ  */
header{height:48px;background:#fff;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;padding:0 1rem;gap:.8rem;box-shadow:0 2px 4px rgba(0,0,0,.05)}
header button{border:none;background:none;font-size:1.2rem;cursor:pointer}
#chooseDir{padding:.25rem .9rem;border-radius:6px;background:var(--accent);color:#fff;font-size:.9rem}
#status{flex:1;font-size:.85rem;opacity:.8}
/* ä¸»å¸ƒå±€ */
#mainWrap{flex:1;display:flex;overflow:hidden}
#sidebar{width:var(--sidebar);background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;transition:transform .3s ease}
#sidebar.hide{transform:translateX(calc(-1*var(--sidebar)))}
#sidebar h3{padding:1rem;border-bottom:1px solid #e2e8f0}
#fileList{flex:1;overflow-y:auto}
.item{padding:.7rem 1rem;border-bottom:1px solid #f1f5f9;white-space:nowrap;cursor:pointer}
.item:hover{background:#f1f5f9}
.item.active{background:var(--accent);color:#fff}
.item span{display:inline-block;min-width:100%;animation:none}
.item:hover span{animation:scroll 6s linear infinite}
@keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
button.accent{padding:.45rem 1rem;margin:1rem;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:.9rem;cursor:pointer}
/* å†…å®¹åŒº */
#content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem}
#poster{width:320px;height:480px;border-radius:14px;background:#cbd5e1 url('https://via.placeholder.com/320x480?text=Poster') center/cover no-repeat;box-shadow:0 6px 20px rgba(0,0,0,.08);cursor:pointer}
#play{padding:.7rem 2.4rem;border:none;border-radius:10px;background:var(--accent);color:#fff;font-size:1rem;cursor:pointer;transition:background .2s}
#play:hover{background:#4338ca}
#hint{color:#64748b}
/* æ¨¡æ€ */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2rem;opacity:0;visibility:hidden;transition:opacity .3s}
#modal.show{opacity:1;visibility:visible}
#closeModal{position:absolute;top:1rem;right:1.4rem;border:none;background:none;font-size:2rem;color:#fff;cursor:pointer}
#subDisplay{flex:1;display:flex;align-items:center;justify-content:center;width:90%;max-width:90%;text-align:center;font-size:clamp(1.3rem,4vw,3.2rem);line-height:1.4;color:#fff}
#timelineWrap{width:90%;max-width:900px;display:flex;align-items:center;gap:.7rem;color:#fff;margin-bottom:4vh}
#slider{flex:1;cursor:pointer}
#timeSt{width:120px;text-align:right;font-variant-numeric:tabular-nums}
#syncBtn{padding:.4rem .9rem;border:none;border-radius:6px;background:var(--accent);color:#fff;font-size:.8rem;cursor:pointer}
</style>
</head>
<body>
<header>
  <button id="toggle">â˜°</button>
  <button id="chooseDir">ğŸ“‚ é€‰æ‹©ç›®å½•</button>
  <span id="status">æœªé€‰æ‹©é¡¹ç›®</span>
</header>
<div id="mainWrap">
  <aside id="sidebar" class="hide">
    <h3>å­—å¹•æ–‡ä»¶</h3>
    <div id="fileList"></div>
    <button id="importBtn" class="accent" disabled>å¯¼å…¥å­—å¹•</button>
  </aside>
  <section id="content">
    <div id="poster" title="ç‚¹å‡»æ›´æ¢æµ·æŠ¥"></div>
    <button id="play" disabled>æ’­æ”¾å­—å¹•</button>
    <p id="hint">åœ¨å·¦ä¸Šé€‰æ‹©é¡¹ç›®ç›®å½• â†’ é€‰æ‹©å­—å¹• â†’ æ’­æ”¾</p>
  </section>
</div>
<input type="file" id="filePicker" style="display:none" />

<!-- æ¨¡æ€ -->
<div id="modal">
  <button id="closeModal">âœ•</button>
  <div id="subDisplay"></div>
  <div id="timelineWrap">
    <input type="range" id="slider" min="0" max="0" step="0.1" value="0" />
    <span id="timeSt">00:00 / 00:00</span>
    <button id="syncBtn">å¯¹é½å­—å¹•</button>
  </div>
</div>

<script>
/* DOM refs */
const toggle=document.getElementById('toggle');
const chooseDir=document.getElementById('chooseDir');
const statusSpan=document.getElementById('status');
const sidebar=document.getElementById('sidebar');
const fileList=document.getElementById('fileList');
const importBtn=document.getElementById('importBtn');
const filePicker=document.getElementById('filePicker');
const poster=document.getElementById('poster');
const play=document.getElementById('play');
const hint=document.getElementById('hint');
const modal=document.getElementById('modal');
const closeModal=document.getElementById('closeModal');
const subDisplay=document.getElementById('subDisplay');
const slider=document.getElementById('slider');
const timeSt=document.getElementById('timeSt');
const syncBtn=document.getElementById('syncBtn');

/* state */
let projectHandle=null, subsDir=null, postersDir=null;
let currentSub=null, subtitles=[];window.subtitles = subtitles;
let playing=false,startEpoch=0,offset=0,rafId,dragging=false;

/* helpers */
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
const getDir=async name=>{try{return await projectHandle.getDirectoryHandle(name)}catch{return await projectHandle.getDirectoryHandle(name,{create:true})}};

/* toggle sidebar */
toggle.onclick=()=>sidebar.classList.toggle('hide');

/* choose directory */
chooseDir.onclick=async()=>{
  try{
    projectHandle=await window.showDirectoryPicker({mode:'readwrite'});
    subsDir=await getDir('subtitles');
    postersDir=await getDir('posters');
    statusSpan.textContent=projectHandle.name;
    importBtn.disabled=false;hint.textContent='é€‰æ‹©å­—å¹• â†’ æ’­æ”¾';
    sidebar.classList.remove('hide');
    await loadSubs();
  }catch(err){console.error(err)}
};

/* load subs */
async function loadSubs(){
  fileList.innerHTML='';currentSub=null;play.disabled=true;poster.style.background="url('https://via.placeholder.com/320x480?text=Poster') center/cover no-repeat";
  for await(const [name,handle] of subsDir.entries()){
    if(handle.kind==='file'&&/\.(srt|ass)$/i.test(name)) makeItem(name,handle);
  }
}
function makeItem(name,handle){
  const div=document.createElement('div');div.className='item';div.innerHTML=`<span>${name}</span>`;
  div.onclick=()=>selectSub(div,handle);
  fileList.appendChild(div);
}
function selectSub(el,handle){
  document.querySelectorAll('.item').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');currentSub=handle;play.disabled=false;loadPoster(handle.name);
}

/* import subtitles */
importBtn.onclick=()=>{
  filePicker.accept='.srt,.ass';filePicker.multiple=true;
  filePicker.onchange=async()=>{
    for(const f of filePicker.files){const dest=await subsDir.getFileHandle(f.name,{create:true});const w=await dest.createWritable();await w.write(await f.arrayBuffer());await w.close()}
    filePicker.value='';loadSubs();
  };filePicker.click();
};

/* poster */
poster.onclick=()=>{
  if(!currentSub){alert('è¯·å…ˆå•å‡»å­—å¹•æ–‡ä»¶');return}
  filePicker.accept='image/*';filePicker.multiple=false;
  filePicker.onchange=async()=>{
    const img=filePicker.files[0];if(!img)return;const base=currentSub.name.replace(/\.[^.]+$/,'');const dest=await postersDir.getFileHandle(base+'.jpg',{create:true});const w=await dest.createWritable();await w.write(await img.arrayBuffer());await w.close();poster.style.background=`url('${URL.createObjectURL(img)}') center/cover no-repeat`;filePicker.value='';
  };filePicker.click();
};
async function loadPoster(subName){
  const base=subName.replace(/\.[^.]+$/,'');
  try{const fh=await postersDir.getFileHandle(base+'.jpg');const f=await fh.getFile();poster.style.background=`url('${URL.createObjectURL(f)}') center/cover no-repeat`}
  catch{poster.style.background="url('https://via.placeholder.com/320x480?text=Poster') center/cover no-repeat"}
}

/* play */
play.onclick=async()=>{
  if(!currentSub){alert('è¯·å…ˆå•å‡»å­—å¹•æ–‡ä»¶');return}
  const file=await currentSub.getFile();const txt=await file.text();subtitles=file.name.endsWith('.srt')?parseSRT(txt):parseASS(txt); window.subtitles = subtitles;
  if(!subtitles.length){alert('æ— æ³•è§£æå­—å¹•');return}
  slider.max=subtitles[subtitles.length-1].end;slider.value=0;timeSt.textContent=`00:00 / ${fmt(slider.max)}`;
  offset=0;startEpoch=performance.now();playing=true;modal.classList.add('show');loop();
};
closeModal.onclick=()=>{playing=false;cancelAnimationFrame(rafId);modal.classList.remove('show')};

/* slider */
slider.addEventListener('input',()=>{dragging=true;offset=parseFloat(slider.value);updateSubtitle(offset)});
slider.addEventListener('change',()=>{startEpoch=performance.now();dragging=false});

/* sync button: è·³åˆ°å½“å‰å­—å¹•å¼€å¤´ */
syncBtn.onclick=()=>{
  const t=parseFloat(slider.value);
  const seg=subtitles.find(s=>t>=s.start&&t<=s.end);
  if(seg){offset=seg.start;slider.value=offset;startEpoch=performance.now();updateSubtitle(offset)}
};

/* main loop */
function loop(){if(!playing)return;const now=performance.now();let t=offset+(now-startEpoch)/1000;if(dragging){t=offset;startEpoch=performance.now()}if(t>slider.max){t=0;offset=0;startEpoch=performance.now()}updateSubtitle(t);rafId=requestAnimationFrame(loop)}
function updateSubtitle(t){subDisplay.textContent=getLine(t);if(!dragging){slider.value=t}timeSt.textContent=`${fmt(t)} / ${fmt(slider.max)}`}
function getLine(t){const s=subtitles.find(x=>t>=x.start&&t<=x.end);return s?s.text:''}

/* parsers */
function parseSRT(raw){const a=raw.split(/\r?\n/);const r=[];for(let i=0;i<a.length;){if(!a[i].trim()){i++;continue}i++;const line=a[i++]||'';if(!/-->/.test(line))continue;const[st,et]=line.split(/ --> /);let txt="";while(i<a.length&&a[i].trim())txt+=a[i++]+"\n";r.push({start:toSec(st),end:toSec(et),text:txt.trim()});i++}return r}
function parseASS(raw){const r=[];raw.split(/\r?\n/).forEach(l=>{if(l.startsWith('Dialogue:')){const p=l.split(',');r.push({start:toSecAss(p[1]),end:toSecAss(p[2]),text:l.slice(l.indexOf(p[9]))})}});return r}
function toSec(t){const [h,m,sec]=t.replace(',','.').split(':');return +h*3600+ +m*60+ +sec}
function toSecAss(t){const [h,m,s]=t.split(':');return +h*3600+ +m*60+ +s}
</script>
  <!-- ===========  è¿½åŠ æ ·å¼  =========== -->
  <style>
    /* ä¾§æ éšè—æ—¶ï¼ŒæŠŠå†…å®¹åŒºå·¦ç§» sidebar å®½åº¦ä»¥å†æ¬¡å±…ä¸­ */
    #content.shift { margin-left: -250px; transition: margin .3s ease; }
    
    /* æœç´¢æ¡†ä¸æŒ‰é’®å¤–è§‚ï¼ˆæ’å…¥åå³ç”Ÿæ•ˆï¼‰ */
    #searchBtn {
      border: none; background: transparent; cursor: pointer;
      font-size: 1.1rem; margin-left: .5rem;
    }
    #searchInput {
      display: none;           /* é»˜è®¤æ”¶èµ· */
      width: calc(100% - 2rem);
      margin: .5rem 1rem; padding: .35rem .6rem;
      border: 1px solid #d1d5db; border-radius: 6px;
      font-size: .9rem;
    }
  </style>
  <!-- â†“â†“â†“ è¿½åŠ çš„æ ·å¼ï¼šæœç´¢æ¡† & æ— åŒ¹é…æç¤º â†“â†“â†“ -->
  <style>
    #searchBox{
      width:calc(100% - 2rem);
      margin:.6rem 1rem .4rem;
      padding:.35rem .6rem;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:.9rem;
    }
    .no-match{
      padding:.7rem 1rem;
      color:#64748b;
      border-bottom:1px solid #f1f5f9;
      cursor:pointer;
    }
    .no-match:hover{background:#f3f4f6}
  </style>
  <!-- --------- è¿½åŠ æ ·å¼ (ç²˜è´´åœ¨æœ€åä¸€ä¸ª </script> ä¹‹å) ---------- -->
  <style>
    /* ä¾§æ æ”¶èµ·æ—¶è®©å†…å®¹é‡æ–°å±…ä¸­ */
    #content.shift { margin-left: -250px; transition: margin .3s ease; }
    /* å¸¸é©»æœç´¢æ¡† & æ— åŒ¹é…æç¤ºæ ·å¼ */
    #searchBox {
      width: calc(100% - 2rem);
      margin: .6rem 1rem .4rem;
      padding: .35rem .6rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: .9rem;
    }
    .no-match {
      padding: .7rem 1rem;
      color: #64748b;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
    }
    .no-match:hover { background: #f3f4f6; }
  </style>
  
  <!-- --------- è¿½åŠ è„šæœ¬ ---------- -->
  <!-- --------- è¿½åŠ æ ·å¼ (ç²˜è´´åœ¨æœ€åä¸€ä¸ª </script> ä¹‹å) ---------- -->
  <style>
    /* ä¾§æ æ”¶èµ·æ—¶è®©å†…å®¹é‡æ–°å±…ä¸­ */
    #content.shift { margin-left: -250px; transition: margin .3s ease; }
    /* å¸¸é©»æœç´¢æ¡† & æ— åŒ¹é…æç¤ºæ ·å¼ */
    #searchBox {
      width: calc(100% - 2rem);
      margin: .6rem 1rem .4rem;
      padding: .35rem .6rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: .9rem;
    }
    .no-match {
      padding: .7rem 1rem;
      color: #64748b;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
    }
    .no-match:hover { background: #f3f4f6; }
  </style>
  <!-- =========== è¿½åŠ æ ·å¼ï¼šæœç´¢æ¡†å¸¸æ˜¾ & æ— åŒ¹é…é¡¹ =========== -->
  <style>
    /* æœç´¢è¾“å…¥æ¡†å¸¸é©»ä¾§æ é¡¶ç«¯ */
    #searchBox {
      width: calc(100% - 2rem);
      margin: .6rem 1rem .4rem;
      padding: .35rem .6rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: .9rem;
    }
    /* OpenSubtitles æç¤ºè¡Œ */
    .no-match {
      padding: .7rem 1rem;
      color: #64748b;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
    }
    .no-match:hover { background: #f3f4f6; }
    /* ä¾§æ æ”¶èµ·æ—¶å†…å®¹å±…ä¸­ */
    #content.shift { margin-left: -250px; transition: margin .3s ease; }
  </style>
  
  <!-- =========== è¿½åŠ è„šæœ¬ï¼šè®°å¿†ç›®å½• + æœç´¢æ¡†é€»è¾‘ + å†…å®¹å±…ä¸­ =========== -->
  <script>
    /* ---------- 1. è®°å¿†ä¸Šæ¬¡ç›®å½• (IndexedDB) ---------- */
    (async ()=> {
      const dbReq = indexedDB.open('rtSubPlayer', 1);
      dbReq.onupgradeneeded = e => e.target.result.createObjectStore('h');
      dbReq.onsuccess = async e => {
        const db = e.target.result;
        const get = db.transaction('h').objectStore('h').get('dir');
        get.onsuccess = async () => {
          const saved = get.result;
          if (!saved) return;
          const granted = await saved.queryPermission({mode:'readwrite'})==='granted'
          || await saved.requestPermission({mode:'readwrite'})==='granted';
          if (!granted) return;
          projectHandle = saved;
          subsDir   = await getDir('subtitles');
          postersDir= await getDir('posters');
          statusSpan.textContent = projectHandle.name;
          importBtn.disabled = false;
          sidebar.classList.remove('hide');
          updateShift();           // ä¾§æ çŠ¶æ€å¯¼è‡´å†…å®¹åç§»
          loadSubs();              // åŸå‡½æ•°ï¼Œåˆ·æ–°åˆ—è¡¨
        };
        
        /* ä¿å­˜ handleï¼šæŒ‚é’©åŸ chooseDir æˆåŠŸå */
        const prev = chooseDir.onclick;
        chooseDir.onclick = async ev => {
          await prev?.call(chooseDir, ev);
          if (projectHandle) {
            const tx=db.transaction('h','readwrite');
            tx.objectStore('h').put(projectHandle,'dir');
          }
        };
      };
    })();
    
    /* ---------- 2. ä¾§æ æ˜¾ / éš æ—¶å†…å®¹åŒºé‡æ–°å±…ä¸­ ---------- */
    function updateShift(){
      content.classList.toggle('shift', sidebar.classList.contains('hide'));
    }
    document.getElementById('toggle')
    .addEventListener('click', ()=> setTimeout(updateShift,10));
    new MutationObserver(updateShift)
    .observe(sidebar,{attributes:true,attributeFilter:['class']});
    
    /* ---------- 3. å¸¸é©»æœç´¢æ¡† + åŠ¨æ€è¿‡æ»¤ + æ— åŒ¹é…æ·å¾„ ---------- */
    (function(){
      const list   = document.getElementById('fileList');
      let   search = document.getElementById('searchBox');
      if(!search){          // æ—§ç‰ˆæœ¬æ²¡æœ‰æœç´¢æ¡† â†’ åˆ›å»º
        search = document.createElement('input');
        search.id='searchBox';
        search.placeholder='æœç´¢å­—å¹•...';
        list.parentElement.insertBefore(search, list);
      }
      
      let noItem;           // â€œå» OpenSubtitlesâ€ è¡Œ
      function showNo(q){
        if(!noItem){
          noItem=document.createElement('div');
          noItem.className='no-match';
          list.appendChild(noItem);
        }
        noItem.textContent=`åœ¨ OpenSubtitles æœç´¢ â€œ${q}â€`;
        noItem.onclick=()=>window.open(
          `https://www.opensubtitles.org/zh/search2/moviename-${encodeURIComponent(q)}/sublanguageid-chi`,
          '_blank');
        noItem.style.display='block';
      }
      function hideNo(){ if(noItem) noItem.style.display='none'; }
        
        function filter(q){
          q=q.trim().toLowerCase();
          let matched=false;
          list.querySelectorAll('.item').forEach(it=>{
            if(!it.dataset.name) it.dataset.name=it.textContent.trim().toLowerCase();
            const hit=it.dataset.name.includes(q);
            it.style.display = hit?'block':'none';
            if (hit) matched=true;
          });
          if(q && !matched) showNo(q); else hideNo();
        }
        
        search.addEventListener('input',e=>filter(e.target.value));
        search.addEventListener('keydown',e=>{
          if(e.key==='Escape'){ search.value=''; filter(''); }
        });
        filter('');           // åˆæ¬¡åŠ è½½ï¼Œæ˜¾ç¤ºå…¨éƒ¨
      })();
      </script>
      <!-- === è¿½åŠ æ ·å¼ï¼šæœç´¢æ¡†å†…éƒ¨çš„â€œÃ—â€æ¸…ç©ºæŒ‰é’® === -->
      <!-- === æœç´¢æ¡†å†…åµŒæŒ‰é’®å®šä½è¡¥ä¸ === -->
      <style>
      /* è®©åŒ…è£¹å±‚è‡ªå·±å¸¦å¤–è¾¹è·ï¼Œå®½åº¦ä¸è¾“å…¥æ¡†ä¸€è‡´ */
      .search-wrap{
        position:relative;
        margin:.6rem 1rem .4rem;   /* åŸæ¥ç»™ input çš„ margin æŒªåˆ°è¿™ */
      }
      /* è¾“å…¥æ¡†å  100% å®½ï¼Œå»æ‰è‡ªèº« marginï¼›å³ä¾§ç•™ 2rem ç»™æŒ‰é’® */
      .search-wrap #searchBox{
        width:100%;
        margin:0;
        padding-right:2rem;
      }
      /* â€œÃ—â€ æŒ‰é’®è·è¾“å…¥æ¡†å³è¾¹ 10pxï¼Œçœ‹ç€æ›´å±…ä¸­ */
      #clearSearch{
        position:absolute;
        right:10px;
        top:50%; transform:translateY(-50%);
        border:none;               /* å–æ¶ˆè¾¹æ¡† */
        background:none;           /* å–æ¶ˆèƒŒæ™¯ */
        -webkit-appearance:none;   /* Safari/Chrome å»é™¤é»˜è®¤ UI */
        appearance:none;   
      }
      </style>
      
      <!-- === è¿½åŠ è„šæœ¬ï¼šæ„å»ºåŒ…è£¹å±‚ + æŒ‰é’®ï¼Œå¹¶ç»‘å®šæ¸…ç©ºé€»è¾‘ === -->
      <script>
      (function(){
        const input = document.getElementById('searchBox');
        if(!input) return;                         // æ²¡æœ‰æœç´¢æ¡†å°±é€€å‡º
        
        /* è‹¥å·²åŒ…è£…è¿‡åˆ™è·³è¿‡ */
        if(!input.parentElement.classList.contains('search-wrap')){
          const wrap = document.createElement('div');
          wrap.className = 'search-wrap';
          input.parentElement.insertBefore(wrap, input);
          wrap.appendChild(input);
        }
        
        /* è‹¥æŒ‰é’®å·²å­˜åœ¨åˆ™ä¸é‡å¤æ·»åŠ  */
        if(document.getElementById('clearSearch')) return;
        
        const btn = document.createElement('button');
        btn.id = 'clearSearch';
        btn.textContent = 'âœ•';
        input.parentElement.appendChild(btn);
        
        /* ç‚¹å‡» Ã— æ¸…ç©ºè¾“å…¥å¹¶è§¦å‘åŸè¿‡æ»¤é€»è¾‘ */
        btn.onclick = () => {
          input.value = '';
          input.dispatchEvent(new Event('input', { bubbles: true }));
        };
      })();
      </script>
      <script>
      (function () {
        const hint   = document.getElementById('hint');
        if (!hint) return;                // æ²¡æœ‰æç¤ºå…ƒç´ ç›´æ¥è·³è¿‡
        
        const READY_TEXT = 'é€‰æ‹©å­—å¹• â†’ æ’­æ”¾';
        
        /* â‘  é’©ä½ loadSubs â€”â€” æ¯å½“ç›®å½•çœŸæ­£åŠ è½½å­—å¹•æ—¶æ›¿æ¢æ–‡æ¡ˆ */
        if (typeof loadSubs === 'function' && !loadSubs.__patched) {
          const orig = loadSubs;
          loadSubs = async function (...args) {
            hint.textContent = READY_TEXT;
            return orig.apply(this, args);
          };
          loadSubs.__patched = true;      // é¿å…é‡å¤åŒ…è£¹
        }
        
        /* â‘¡ é’©ä½ chooseDir â€”â€” æ‰‹åŠ¨é‡æ–°é€‰æ‹©ç›®å½•åä¹Ÿè¦†ç›–æ–‡æ¡ˆ */
        if (chooseDir) {
          const prevClick = chooseDir.onclick;
          chooseDir.onclick = async ev => {
            await prevClick?.call(chooseDir, ev);
            if (projectHandle) hint.textContent = READY_TEXT;
          };
        }
      })();
      </script>
      <script>
      /* é€‰å®Œç›®å½•åï¼šå°è¯•æŠŠç«™ç‚¹æ•°æ®æŒä¹…åŒ–ï¼Œé¿å…è¢«æµè§ˆå™¨å›æ”¶ */
      chooseDir.addEventListener('click', async () => {
        if (navigator.storage?.persist) {
          const granted = await navigator.storage.persist();
          console.log('æŒä¹…åŒ–å­˜å‚¨ï¼š', granted ? 'æˆåŠŸ' : 'å¤±è´¥ / å·²æ‹’ç»');
        }
      });
      </script>
      <!-- === è¿½åŠ è„šæœ¬ï¼šæ— åŒ¹é…æ—¶å†ç»™å‡º SubHD æœç´¢é€‰é¡¹ === -->
      <script>
      (function(){
        const list   = document.getElementById('fileList');
        const search = document.getElementById('searchBox');
        if(!list || !search) return;
        
        /* å¤ç”¨å·²å­˜åœ¨çš„ .no-match è¡Œ â€”â€” æ–°å¢ç¬¬äºŒè¡Œ for SubHD */
        let noHD;   // SubHD æç¤ºè¡Œ
        
        function ensureHD(q){
          if(!noHD){
            noHD=document.createElement('div');
            noHD.className='no-match';
            list.appendChild(noHD);
          }
          noHD.textContent=`åœ¨ SubHD æœç´¢ â€œ${q}â€`;
          noHD.onclick=()=>window.open(`https://subhd.tv/search/${encodeURIComponent(q)}`,'_blank');
          noHD.style.display='block';
        }
        function hideHD(){ if(noHD) noHD.style.display='none'; }
          
          /* ç›‘å¬ searchBox çš„è¾“å…¥äº‹ä»¶ â€”â€” ä¸æ”¹åŠ¨åŸæœ‰ filter() */
          search.addEventListener('input',()=>{
            const q=search.value.trim().toLowerCase();
            const anyVisible=[...list.querySelectorAll('.item')].some(el=>el.style.display!=='none');
            if(q && !anyVisible){ ensureHD(q); } else hideHD();
          });
          
          /* Escape æ¸…ç©ºæ—¶ä¹Ÿéšè— SubHD è¡Œ */
          search.addEventListener('keydown',e=>{
            if(e.key==='Escape') hideHD();
          });
        })();
        </script>
        <!-- === è®©å†…å®¹åŒºå±•å¼€/æ”¶èµ·éƒ½å¸¦åŠ¨ç”» + å¯åŠ¨æ—¶é»˜è®¤å±•å¼€ä¾§æ  === -->
        <style>
        /* æ— è®ºæ·»åŠ è¿˜æ˜¯ç§»é™¤ .shiftï¼Œéƒ½æœ‰ margin è¿‡æ¸¡ */
        #content{ transition: margin .3s ease; }
        </style>
        
        <script>
        /* é¡µé¢é¦–æ¬¡åŠ è½½ï¼šå¦‚æœ sidebar å¸¦ hide å°±å»æ‰ï¼Œå¹¶åˆ·æ–°ä½ç§» */
        document.addEventListener('DOMContentLoaded',()=>{
          if(sidebar.classList.contains('hide')){
            sidebar.classList.remove('hide');   // é»˜è®¤æ˜¾ç¤ºä¾§æ 
            updateShift();                      // è°ƒæ•´ #content ä½ç½®
          }
        });
        </script>
        <!-- === æ·±è‰²æ¨¡å¼è¡¥ä¸ï¼ˆè‡ªåŠ¨è·Ÿéšç³»ç»Ÿï¼‰ === -->
        <style>
        /* ç³»ç»Ÿå¤„äº dark mode æ—¶è¦†ç›–é¢œè‰²å˜é‡ */
        @media (prefers-color-scheme: dark){
          :root{
            /* 1. èƒŒæ™¯æ”¹ä¸º #252525 */
            --bg:#252525;
            
            /* 2. æ–‡å­—åè½¬ä¸ºæµ…è‰² */
            --text:#f8fafc;

          }
          
          /* é¡¶æ  / ä¾§æ æ”¹æ·±è‰²ï¼Œè¾¹çº¿é€‚å½“åŠ æ·± */
          header,
          #sidebar{
            background:#1e1e1e;
            border-color:#333;
          }
          
          /* åˆ—è¡¨è¡Œ hover / é€‰ä¸­é…åˆæ·±è‰² */
          .item:hover{background:#2d2d2d}
          .item.active{background:var(--accent);color:#000}
          
          /* æ¨¡æ€é®ç½©ä»ä¿æŒ rgba é»‘ï¼Œä½†ä¸‹æ–¹å­—å¹•æ–‡å­—å·²ç”¨ --text */
          #modal{background:rgba(0,0,0,.9)}
          
          /* é»˜è®¤æµ·æŠ¥å ä½åº•è‰²è°ƒæš—ä¸€äº› */
          #poster{background-color:#404040}
        }
        </style>
        <script>
        /* ========= è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€æ¡å­—å¹•ï¼ˆåŒä¿é™©ï¼‰ ========= */
        (function () {
          const list = document.getElementById('fileList');
          if (!list) return;
          
          /* ç‚¹å‡»åˆ—è¡¨ä¸­é¦–ä¸ªâ€œå¯è§â€çš„ .item */
          function clickFirst() {
            const first = list.querySelector('.item:not([style*="display: none"])');
            if (first) first.click();
          }
          
          /* ---- A. åŒ…è£… loadSubs() ---- */
          if (typeof loadSubs === 'function' && !loadSubs.__patched) {
            const orig = loadSubs;
            loadSubs = async function (...args) {
              await orig.apply(this, args);
              /* ç­‰ DOM æ›´æ–°å®Œæˆå†å°è¯•ç‚¹å‡» */
              setTimeout(clickFirst, 0);
            };
            loadSubs.__patched = true;
          }
          
          /* ---- B. ç›‘å¬åˆ—è¡¨å˜åŠ¨ï¼ˆé˜²æŠ– 50msï¼‰ ---- */
          let timer = null;
          new MutationObserver(() => {
            clearTimeout(timer);
            timer = setTimeout(clickFirst, 50);
          }).observe(list, { childList: true, subtree: false });
        })();
        </script>
        <script>
        /* ===== æŠŠ 02:03 â†’ 00:02:03 çš„è¡¥ä¸ ===== */
        (function () {
          /* æ–°æ ¼å¼åŒ–å‡½æ•°ï¼šhh:mm:ss */
          const hms = sec => {
            const h = Math.floor(sec / 3600);
            const m = Math.floor(sec % 3600 / 60);
            const s = Math.floor(sec % 60);
            return (
              String(h).padStart(2, '0') + ':' +
              String(m).padStart(2, '0') + ':' +
              String(s).padStart(2, '0')
            );
          };
          
          /* ---------- 1. åŒ…è£… updateSubtitle ---------- */
          if (typeof updateSubtitle === 'function' && !updateSubtitle.__hms) {
            const orig = updateSubtitle;
            updateSubtitle = function (t) {
              orig(t);  // å…ˆæ‰§è¡ŒåŸé€»è¾‘ï¼ˆä»å†™ mm:ssï¼‰
              /* å†æŠŠ timeSt æ”¹æˆ hh:mm:ss */
              timeSt.textContent = `${hms(t)} / ${hms(parseFloat(slider.max))}`;
            };
            updateSubtitle.__hms = true;
          }
          
          /* ---------- 2. åŒ…è£… play.onclickï¼ˆåˆå§‹åŒ–æ—¶é•¿è¡Œï¼‰ ---------- */
          if (play && !play.__hmsPatched) {
            const origPlay = play.onclick;
            play.onclick = async ev => {
              await origPlay?.call(play, ev);
              /* æ’­æ”¾å™¨å¯åŠ¨åï¼Œé‡å†™ 00:00 è¡Œä¸ºä¸‰æ®µå¼ */
              timeSt.textContent = `00:00:00 / ${hms(parseFloat(slider.max))}`;
            };
            play.__hmsPatched = true;
          }
        })();
        </script>
        <style>
        /* â¬‡ æ–°å¢ï¼šæ—¶é—´æ ‡ç­¾æ ·å¼ + åŠ¨ç”»ä¿æŒ */
        .time-lbl{
          min-width:72px;                /* ä¸‰æ®µæ•°å­—å®½åº¦ä¸€è‡´ */
          text-align:center;
          font-variant-numeric:tabular-nums;
          color:#fff;
        }
        #curTime{margin-right:.7rem;}    /* å·¦è¾¹æ—¶é—´ç¦» slider 0.7rem */
        #totTime{margin-left:.7rem;}     /* å³è¾¹æ—¶é—´ç¦»æŒ‰é’® 0.7rem */
        
        /* è®© #content ç§»åŠ¨æ—¶å¸¦è¿‡æ¸¡ï¼ˆå¦‚æœä¹‹å‰å·²å†™å¯å¿½ç•¥ï¼‰ */
        #content{transition:margin .3s ease;}
        </style>
        <script>
        (function(){
          /* ç›®æ ‡å®¹å™¨ */
          const wrap = document.getElementById('timelineWrap');
          if(!wrap) return;                // å®¹é”™
          
          const slider = document.getElementById('slider');
          const timeSt = document.getElementById('timeSt');  // æ—§å…ƒç´ 
          
          /* -------- a. é¦–æ¬¡è¿è¡Œï¼šæ’å…¥å·¦å³æ ‡ç­¾ï¼Œå¹¶éšè—æ—§ timeSt -------- */
          if(!document.getElementById('curTime')){
            const cur = document.createElement('span');
            cur.id = 'curTime';   cur.className = 'time-lbl'; cur.textContent = '00:00:00';
            
            const tot = document.createElement('span');
            tot.id = 'totTime';   tot.className = 'time-lbl'; tot.textContent = '00:00:00';
            
            wrap.insertBefore(cur, slider);   // æ”¾åœ¨ slider å·¦è¾¹
            wrap.insertBefore(tot, timeSt);   // æ”¾åœ¨æ—§ span å‰
            timeSt.style.display = 'none';    // å½»åº•éšè—æ—§åˆå¹¶æ–‡æœ¬
          }
          
          const curTime = document.getElementById('curTime');
          const totTime = document.getElementById('totTime');
          
          /* -------- b. hh:mm:ss æ ¼å¼åŒ–å‡½æ•° -------- */
          const hms = s=>{
            const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
          };
          
          /* -------- c. åŒ…è£… updateSubtitle(t)ï¼šå®æ—¶åˆ·æ–°å·¦å³æ˜¾ç¤º -------- */
          if(typeof updateSubtitle==='function' && !updateSubtitle.__split){
            const orig = updateSubtitle;
            updateSubtitle = function(t){
              orig(t);                          // ä¿ç•™åŸè¡Œä¸º
              curTime.textContent = hms(t);     // å·¦ï¼šå½“å‰
              totTime.textContent = hms(+slider.max); // å³ï¼šæ€»æ—¶é•¿
            };
            updateSubtitle.__split = true;
          }
          
          /* -------- d. åŒ…è£… play.onclickï¼šåˆšè¿›æ¨¡æ€æ—¶å…ˆå†™ä¸€æ¬¡ -------- */
          if(typeof play!=='undefined' && !play.__splitInit){
            const old = play.onclick;
            play.onclick = async ev=>{
              await old?.call(play, ev);         // è®©åŸæ’­æ”¾é€»è¾‘å…ˆè·‘
              curTime.textContent = '00:00:00';
              totTime.textContent = hms(+slider.max);
            };
            play.__splitInit = true;
          }
        })();
        </script>
        <style>
        /* æ”¾å¤§é•œæŒ‰é’®å­—ä½“å’Œæ¿€æ´»çŠ¶æ€ */
        #zoomBtn{
          border:none;background:none;cursor:pointer;
          font-size:1.3rem;color:#fff;transition:transform .2s;
        }
        #zoomBtn.active{color:var(--accent);transform:scale(1.2);}
        </style>
        <script>
        (function(){
          const wrap = document.getElementById('timelineWrap');
          if(!wrap) return;                 // æ²¡æœ‰æ—¶é—´è½´å®¹å™¨ç›´æ¥è·³è¿‡
          
          /* è‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºæ”¾å¤§é•œæŒ‰é’® */
          if(!document.getElementById('zoomBtn')){
            const btn = document.createElement('button');
            btn.id = 'zoomBtn';
            btn.innerHTML = 'ğŸ”';
            wrap.insertBefore(btn, wrap.firstChild);   // æ”¾åœ¨æ—¶é—´è½´æœ€å·¦ä¾§
            
            const sub  = document.getElementById('subDisplay');
            const small = 'clamp(1.3rem,4vw,3.2rem)'; // åŸå­—å·
            const large = '8vw';     // æ”¾å¤§å­—å·
            let zoom = false;
            
            btn.onclick = () => {
              zoom = !zoom;
              sub.style.fontSize = zoom ? large : small;
              btn.classList.toggle('active', zoom);
            };
          }
        })();
        </script>
        <!-- === èƒŒæ™¯é«˜æ–¯æ¨¡ç³Šï¼ˆåªåœ¨æ¨¡æ€æ˜¾ç¤ºæ—¶å¼€å¯ï¼‰ === -->
        <style>
        /* é»˜è®¤æ— æ»¤é•œï¼Œé¿å…æ€§èƒ½è´Ÿæ‹… */
        #modal { backdrop-filter:none; }
        
        /* æ‰“å¼€æ¨¡æ€åå¯ç”¨ 12px æ¨¡ç³Šï¼Œè®©åæ™¯æŸ”åŒ– */
        #modal.show { backdrop-filter:blur(12px); }
        </style>
        <!-- ========== è¡¥ä¸ï¼šæ¨¡æ€ â® â¯ â­ æŒ‰é’®åŠŸèƒ½ ========== -->
        <style>
        #subCtrlBox{
          display:flex;justify-content:center;align-items:center;
          gap:2.2rem;margin-top:-1.1rem;
        }
        .ctrlBtn{
          border:none;background:none;cursor:pointer;
          font-size:2.3rem;line-height:1;color:#fff;transition:transform .18s;
        }
        .ctrlBtn:hover{transform:scale(1.15)}
        </style>
        <script>
        (() => {
          // é˜²æ­¢é‡å¤æ’å…¥
          if (window.__rtSubCtrlX) return;
          window.__rtSubCtrlX = true;
          
          const modal  = document.getElementById('modal');
          const slider = document.getElementById('slider');
          
          // æ¯æ¬¡æ¨¡æ€æ‰“å¼€éƒ½è‡ªåŠ¨æ’å…¥æŒ‰é’®ï¼Œå¹¶ç»‘å®šåŠŸèƒ½
          new MutationObserver(() => {
            if (!modal.classList.contains('show')) return;
            
            const wrap = document.getElementById('timelineWrap');
            // è‹¥å·²ç»æœ‰æŒ‰é’®åŒºæˆ–å…³é”®å˜é‡ç¼ºå¤±åˆ™é€€å‡º
            if (!wrap || !slider || document.getElementById('subCtrlBox')) return;
            
            // æ’å…¥æŒ‰é’®åŒº
            wrap.insertAdjacentHTML('beforebegin', `
      <div id="subCtrlBox">
        <button id="btnPrev" class="ctrlBtn">â®</button>
        <button id="btnPP"   class="ctrlBtn">â¸</button>
        <button id="btnNext" class="ctrlBtn">â­</button>
      </div>`);
            
            // å…ƒç´ å¼•ç”¨
            const $ = id => document.getElementById(id);
            const prev = $('btnPrev'), next = $('btnNext'), pp = $('btnPP');
            
            // å­—å¹•æ•°æ®ç›´æ¥ç”¨ subtitlesï¼ˆä½ çš„ä»£ç é‡Œå§‹ç»ˆç”¨ subtitles ä½œä¸ºå…¨å±€ï¼‰
            function idxAt(t) {
              return Array.isArray(window.subtitles)
              ? window.subtitles.findIndex(s => t >= s.start && t <= s.end)
              : -1;
            }
            function nearestIdx(t, dir) {
              const arr = window.subtitles || [];
              let lo=0, hi=arr.length-1, mid, last=-1;
              while(lo<=hi){
                mid=(lo+hi)>>1;
                if(arr[mid].start<=t){last=mid;lo=mid+1;}else hi=mid-1;
              }
              return dir==='prev'
              ? (last>-1?last:0)
              : (last<arr.length-1?last+1:arr.length-1);
            }
            function jump(i, keepPause=false) {
              const arr = window.subtitles || [];
              if(i<0||i>=arr.length) return;
              offset = arr[i].start;
              slider.value = offset;
              updateSubtitle(offset);
              startEpoch = performance.now();
              if(!keepPause && !window.playing && typeof window.loop === 'function') {
                window.playing = true; window.loop();
                pp.textContent = 'â¸';
              }
            }
            function pause() {
              window.playing = false;
              if (typeof rafId !== 'undefined') cancelAnimationFrame(rafId);
              pp.textContent = 'â–¶';
            }
            function resume() {
              window.playing = true;
              if (typeof window.loop === 'function') window.loop();
              pp.textContent = 'â¸';
            }
            
            // ç»‘å®šäº‹ä»¶
            prev.onclick = () => {
              const t=+slider.value, cur=idxAt(t);
              const arr=window.subtitles||[];
              if(!arr.length) return;
              jump(cur>0?cur-1:nearestIdx(t,'prev'), true);
            };
            next.onclick = () => {
              const t=+slider.value, cur=idxAt(t);
              const arr=window.subtitles||[];
              if(!arr.length) return;
              jump(cur!==-1&&cur<arr.length-1?cur+1:nearestIdx(t,'next'), true);
            };
            pp.onclick = () => {
              const t=+slider.value, cur=idxAt(t);
              if(cur!==-1) jump(cur, true);
              window.playing ? pause() : resume();
            };
          }).observe(modal,{attributes:true,attributeFilter:['class']});
        })();
        </script>
</body>
</html>